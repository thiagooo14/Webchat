<html>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="http://chancejs.com/chance.min.js"></script>
  <head>
    <link rel="stylesheet" href="style.css" />
    <title>Web Chat Project</title>
  </head>
  <body>
    <div class="main-page">
      <div class="user">
        <h1 id="userName"></h1>

        <input id="nickInput" class="nickInput" data-testid="nickname-box" type="text" />
        <button id="changeNick" class="changeNick" data-testid="nickname-save">Nick</button>
      </div>
      
      <div class="menssages">
        <ul id="listMessages" class="listMessages"></ul>
      </div>

      <div class="loged">
        <ul id="conectedUsers" class="conectedUsers"></ul>
      </div>

      <div class="mensage">
        <input id="textInput" class="textInput" data-testid="message-box" autocomplete="off" />
        <button id="sendMessage" class="sendMessage" data-testid="send-button">Send</button>
      </div>
    </div>

    <script>
      const socket = io();

      const user = document.querySelector('#userName');

      const chatMessageInput = document.querySelector('#textInput');
      const nicknameInput = document.querySelector('#nickInput');

      const nickBtn = document.querySelector('#changeNick');
      const msgBtn = document.querySelector('#sendMessage');

      const onlineUsers = document.querySelector('#conectedUsers');
      const messages = document.querySelector('#listMessages');

      window.onload = () => {
        user.innerText = chance.first();
        let nickname = user.innerText;

        socket.emit('newNick', { nickname });

        nickBtn.addEventListener('click', (event) => {
          event.preventDefault();
          nickname = nicknameInput.value;
          user.innerText = nickname;

          socket.emit('newNick', { nickname });
        });

        msgBtn.addEventListener('click', (event) => {
          event.preventDefault();
          let chatMessage = chatMessageInput.value;

          socket.emit('message', { nickname, chatMessage });
        });

        socket.on('userList', async (data) => {
          onlineUsers.innerHTML = await data
            .map(
              (users) => `<li data-testid="online-user">${users}</li>
            ${users === nickname ? '' : ''}`,
            )
            .join(' ');
        });

        socket.on('history', (data) => {
          messages.innerHTML = data
            .map((mes) => `<li data-testid="message">${mes.message}</li>`)
            .join('');
        });

        socket.on('message', (data) => {
          const li = document.createElement('li');
          li.setAttribute('data-testid', 'message');
          li.textContent = data;

          messages.appendChild(li);
        });
      };
    </script>
  </body>
</html>
